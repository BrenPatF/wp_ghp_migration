SQL> SELECT 'Start: ' || To_Char(SYSDATE,'DD-MON-YYYY HH24:MI:SS') FROM DUAL;

'START:'||TO_CHAR(SYSDATE,'DD-MON-YY
------------------------------------
Start: 14-JUL-2013 09:07:43

SQL> BEGIN
  2    Utils.Clear_Log;
  3  END;
  4  /

PL/SQL procedure successfully completed.

SQL> BREAK ON tot_dist
SQL> PROMPT Ordered solution
Ordered solution
SQL> WITH legs AS (
  2  SELECT twn.id town_id,
  3         Lag (twn.id) OVER (ORDER BY twn.id) town_id_prior
  4    FROM towns twn
  5  )
  6  SELECT Round (Sum (d.dst) OVER ()) tot_dist,
  7         t.id,
  8         t.name,
  9         Round (d.dst) leg_dist
 10    FROM towns t
 11    JOIN legs l
 12      ON l.town_id = t.id
 13    LEFT JOIN distances d
 14      ON d.a = l.town_id_prior
 15     AND d.b = l.town_id
 16  ORDER BY t.id
 17  /

  TOT_DIST         ID NAME                             LEG_DIST
---------- ---------- ------------------------------ ----------
         7          1 Left Floor
                    2 Left Peak                               2
                    3 Midfield                                1
                    4 Right Peak                              1
                    5 Right Floor                             2

SQL> SET TIMING ON
SQL> @..\sql\Town_Round_SQL 5 5 -1
old   2:   :KEEP_NUM_ROOT := &1;
new   2:   :KEEP_NUM_ROOT := 5;
old   3:   :KEEP_NUM := &2;
new   3:   :KEEP_NUM := 5;
old   4:   :SIGN := &3;
new   4:   :SIGN := -1;

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.00
Running for sign, root, keep root, keep values of...

      SIGN
----------
        -1


KEEP_NUM_ROOT
-------------
            5


  KEEP_NUM
----------
         5

Top n solutions

ROOT_LEG       PATH_RNK   TOT_DIST    TOWN_ID NAME                             LEG_DIST   CUM_DIST
------------ ---------- ---------- ---------- ------------------------------ ---------- ----------
1 -> 2                1       13.1          1 Left Floor
                                            2 Left Peak                            2.24       2.24
                                            5 Right Floor                          3.61       5.84
                                            3 Midfield                             2.24       8.08
                                            4 Right Peak                           1.41       9.49
                                            1 Left Floor                           3.61       13.1
                      2      11.89          1 Left Floor
                                            2 Left Peak                            2.24       2.24
                                            4 Right Peak                              2       4.24
                                            3 Midfield                             1.41       5.65
                                            5 Right Floor                          2.24       7.89
                                            1 Left Floor                              4      11.89
                      3      11.73          1 Left Floor
                                            2 Left Peak                            2.24       2.24
                                            5 Right Floor                          3.61       5.84
                                            4 Right Peak                           2.24       8.08
                                            3 Midfield                             1.41       9.49
                                            1 Left Floor                           2.24      11.73
                      4      11.73          1 Left Floor
                                            2 Left Peak                            2.24       2.24
                                            3 Midfield                             1.41       3.65
                                            5 Right Floor                          2.24       5.89
                                            4 Right Peak                           2.24       8.12
                                            1 Left Floor                           3.61      11.73
                      5      10.94          1 Left Floor
                                            2 Left Peak                            2.24       2.24
                                            4 Right Peak                              2       4.24
                                            5 Right Floor                          2.24       6.47
                                            3 Midfield                             2.24       8.71
                                            1 Left Floor                           2.24      10.94
1 -> 4                1      13.68          1 Left Floor
                                            4 Right Peak                           3.61       3.61
                                            2 Left Peak                               2       5.61
                                            5 Right Floor                          3.61       9.21
                                            3 Midfield                             2.24      11.45
                                            1 Left Floor                           2.24      13.68
                      2      13.26          1 Left Floor
                                            4 Right Peak                           3.61       3.61
                                            2 Left Peak                               2       5.61
                                            3 Midfield                             1.41       7.02
                                            5 Right Floor                          2.24       9.26
                                            1 Left Floor                              4      13.26
                      3       13.1          1 Left Floor
                                            4 Right Peak                           3.61       3.61
                                            5 Right Floor                          2.24       5.84
                                            2 Left Peak                            3.61       9.45
                                            3 Midfield                             1.41      10.86
                                            1 Left Floor                           2.24       13.1
                      4       13.1          1 Left Floor
                                            4 Right Peak                           3.61       3.61
                                            3 Midfield                             1.41       5.02
                                            5 Right Floor                          2.24       7.26
                                            2 Left Peak                            3.61      10.86
                                            1 Left Floor                           2.24       13.1
                      5      11.73          1 Left Floor
                                            4 Right Peak                           3.61       3.61
                                            5 Right Floor                          2.24       5.84
                                            3 Midfield                             2.24       8.08
                                            2 Left Peak                            1.41       9.49
                                            1 Left Floor                           2.24      11.73
1 -> 5                1      14.04          1 Left Floor
                                            5 Right Floor                             4          4
                                            2 Left Peak                            3.61       7.61
                                            3 Midfield                             1.41       9.02
                                            4 Right Peak                           1.41      10.43
                                            1 Left Floor                           3.61      14.04
                      2      13.26          1 Left Floor
                                            5 Right Floor                             4          4
                                            2 Left Peak                            3.61       7.61
                                            4 Right Peak                              2       9.61
                                            3 Midfield                             1.41      11.02
                                            1 Left Floor                           2.24      13.26
                      3      13.26          1 Left Floor
                                            5 Right Floor                             4          4
                                            3 Midfield                             2.24       6.24
                                            2 Left Peak                            1.41       7.65
                                            4 Right Peak                              2       9.65
                                            1 Left Floor                           3.61      13.26
                      4      11.89          1 Left Floor
                                            5 Right Floor                             4          4
                                            4 Right Peak                           2.24       6.24
                                            2 Left Peak                               2       8.24
                                            3 Midfield                             1.41       9.65
                                            1 Left Floor                           2.24      11.89
                      5      11.89          1 Left Floor
                                            5 Right Floor                             4          4
                                            3 Midfield                             2.24       6.24
                                            4 Right Peak                           1.41       7.65
                                            2 Left Peak                               2       9.65
                                            1 Left Floor                           2.24      11.89
2 -> 5                1      14.04          2 Left Peak
                                            5 Right Floor                          3.61       3.61
                                            1 Left Floor                              4       7.61
                                            4 Right Peak                           3.61      11.21
                                            3 Midfield                             1.41      12.63
                                            2 Left Peak                            1.41      14.04
                      2      13.68          2 Left Peak
                                            5 Right Floor                          3.61       3.61
                                            3 Midfield                             2.24       5.84
                                            1 Left Floor                           2.24       8.08
                                            4 Right Peak                           3.61      11.68
                                            2 Left Peak                               2      13.68
                      3      13.26          2 Left Peak
                                            5 Right Floor                          3.61       3.61
                                            1 Left Floor                              4       7.61
                                            3 Midfield                             2.24       9.84
                                            4 Right Peak                           1.41      11.26
                                            2 Left Peak                               2      13.26
                      4       13.1          2 Left Peak
                                            5 Right Floor                          3.61       3.61
                                            4 Right Peak                           2.24       5.84
                                            1 Left Floor                           3.61       9.45
                                            3 Midfield                             2.24      11.68
                                            2 Left Peak                            1.41       13.1
                      5      11.73          2 Left Peak
                                            5 Right Floor                          3.61       3.61
                                            4 Right Peak                           2.24       5.84
                                            3 Midfield                             1.41       7.26
                                            1 Left Floor                           2.24       9.49
                                            2 Left Peak                            2.24      11.73
3 -> 5                1      13.68          3 Midfield
                                            5 Right Floor                          2.24       2.24
                                            2 Left Peak                            3.61       5.84
                                            4 Right Peak                              2       7.84
                                            1 Left Floor                           3.61      11.45
                                            3 Midfield                             2.24      13.68
                      2      13.26          3 Midfield
                                            5 Right Floor                          2.24       2.24
                                            1 Left Floor                              4       6.24
                                            4 Right Peak                           3.61       9.84
                                            2 Left Peak                               2      11.84
                                            3 Midfield                             1.41      13.26
                      3       13.1          3 Midfield
                                            5 Right Floor                          2.24       2.24
                                            2 Left Peak                            3.61       5.84
                                            1 Left Floor                           2.24       8.08
                                            4 Right Peak                           3.61      11.68
                                            3 Midfield                             1.41       13.1
                      4      11.89          3 Midfield
                                            5 Right Floor                          2.24       2.24
                                            1 Left Floor                              4       6.24
                                            2 Left Peak                            2.24       8.47
                                            4 Right Peak                              2      10.47
                                            3 Midfield                             1.41      11.89
                      5      11.73          3 Midfield
                                            5 Right Floor                          2.24       2.24
                                            4 Right Peak                           2.24       4.47
                                            1 Left Floor                           3.61       8.08
                                            2 Left Peak                            2.24      10.31
                                            3 Midfield                             1.41      11.73

150 rows selected.

Elapsed: 00:00:00.16

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.29
SQL> 
SQL> @..\..\Brendan\sql\L_Log_Default

TEXT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  1jjurvqx0sax1, child number 0
-------------------------------------
WITH count_towns AS (/* XTSP  */ SELECT Count(*) n_towns FROM towns ),
dist_from_root AS ( SELECT a, b, dst, Row_Number () OVER (ORDER BY
:SIGN * dst) rnk_by_dst, Count(DISTINCT a) OVER () + 1 n_towns   FROM
distances  WHERE b > a ),  rsf (root, root_leg, path_rnk, nxt_id, lev,
tot_price, path, n_towns) AS ( SELECT a, a || ' -> ' || b, 0, d.b, 2,
d.dst,        CAST ('|' || LPad (d.a, 3, '0') || '|' || LPad (d.b, 3,
'0') AS VARCHAR2(4000)) path,        d.n_towns   FROM dist_from_root d
WHERE d.rnk_by_dst <= :KEEP_NUM_ROOT  UNION ALL SELECT r.root,
r.root_leg,        Row_Number() OVER (PARTITION BY r.root_leg ORDER BY
:SIGN * (r.tot_price + d.dst)),        d.b,        r.lev + 1,
r.tot_price + d.dst,        r.path || '|' || LPad (d.b, 3, '0'),
r.n_towns   FROM rsf r   JOIN distances d     ON d.a = r.nxt_id    AND
r.path NOT LIKE '%' || '|' || LPad (d.b, 3, '0') || '%'  WHERE
r.path_rnk <= :KEEP_NUM ), circuits AS ( SELECT r.root_leg,
Row_Number() OVER (PARTITI

Plan hash value: 2429809240

----------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                                             | Name        | Starts | E-Rows | A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
----------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                                      |             |      1 |        |    150 |00:00:00.01 |     652 |       |       |          |
|   1 |  WINDOW SORT                                          |             |      1 |     10 |    150 |00:00:00.01 |     652 | 27648 | 27648 |24576  (0)|
|   2 |   NESTED LOOPS OUTER                                  |             |      1 |     10 |    150 |00:00:00.01 |     652 |       |       |          |
|   3 |    MERGE JOIN                                         |             |      1 |     10 |    150 |00:00:00.01 |     401 |       |       |          |
|   4 |     TABLE ACCESS BY INDEX ROWID                       | TOWNS       |      1 |      5 |      5 |00:00:00.01 |       2 |       |       |          |
|   5 |      INDEX FULL SCAN                                  | SYS_C008004 |      1 |      5 |      5 |00:00:00.01 |       1 |       |       |          |
|*  6 |     SORT JOIN                                         |             |      5 |     10 |    150 |00:00:00.01 |     399 | 15360 | 15360 |14336  (0)|
|   7 |      VIEW                                             |             |      1 |     10 |    150 |00:00:00.01 |     399 |       |       |          |
|   8 |       WINDOW SORT                                     |             |      1 |     10 |    150 |00:00:00.01 |     399 | 18432 | 18432 |16384  (0)|
|   9 |        MERGE JOIN CARTESIAN                           |             |      1 |     10 |    150 |00:00:00.01 |     399 |       |       |          |
|  10 |         VIEW                                          |             |      1 |      1 |      6 |00:00:00.01 |       1 |       |       |          |
|  11 |          CONNECT BY WITHOUT FILTERING                 |             |      1 |        |      6 |00:00:00.01 |       1 |       |       |          |
|  12 |           VIEW                                        |             |      1 |      1 |      1 |00:00:00.01 |       1 |       |       |          |
|  13 |            SORT AGGREGATE                             |             |      1 |      1 |      1 |00:00:00.01 |       1 |       |       |          |
|  14 |             INDEX FULL SCAN                           | SYS_C008004 |      1 |      5 |      5 |00:00:00.01 |       1 |       |       |          |
|  15 |         BUFFER SORT                                   |             |      6 |     10 |    150 |00:00:00.01 |     398 |  2048 |  2048 | 2048  (0)|
|* 16 |          VIEW                                         |             |      1 |     10 |     25 |00:00:00.01 |     398 |       |       |          |
|* 17 |           WINDOW SORT PUSHED RANK                     |             |      1 |     10 |     25 |00:00:00.01 |     398 |  4096 |  4096 | 4096  (0)|
|  18 |            NESTED LOOPS                               |             |      1 |        |     25 |00:00:00.01 |     398 |       |       |          |
|  19 |             NESTED LOOPS                              |             |      1 |     10 |     25 |00:00:00.01 |     373 |       |       |          |
|* 20 |              VIEW                                     |             |      1 |     12 |     25 |00:00:00.01 |     346 |       |       |          |
|  21 |               UNION ALL (RECURSIVE WITH) BREADTH FIRST|             |      1 |        |     75 |00:00:00.01 |     346 |       |       |          |
|* 22 |                VIEW                                   |             |      1 |     10 |      5 |00:00:00.01 |     213 |       |       |          |
|* 23 |                 WINDOW SORT PUSHED RANK               |             |      1 |     10 |      6 |00:00:00.01 |     213 |  2048 |  2048 | 2048  (0)|
|  24 |                  WINDOW BUFFER                        |             |      1 |     10 |     10 |00:00:00.01 |     213 |  2048 |  2048 | 2048  (0)|
|  25 |                   TABLE ACCESS BY INDEX ROWID         | DISTANCES   |      1 |     10 |     10 |00:00:00.01 |     213 |       |       |          |
|* 26 |                    INDEX FULL SCAN                    | DISTANCE_PK |      1 |     10 |     10 |00:00:00.01 |     212 |       |       |          |
|  27 |                WINDOW SORT                            |             |      4 |      2 |     70 |00:00:00.01 |     133 |  6144 |  6144 | 4096  (0)|
|  28 |                 NESTED LOOPS                          |             |      4 |        |     70 |00:00:00.01 |     133 |       |       |          |
|  29 |                  NESTED LOOPS                         |             |      4 |      2 |     70 |00:00:00.01 |     130 |       |       |          |
|  30 |                   RECURSIVE WITH PUMP                 |             |      4 |        |     70 |00:00:00.01 |       0 |       |       |          |
|* 31 |                   INDEX RANGE SCAN                    | DISTANCE_PK |     70 |      1 |     70 |00:00:00.01 |     130 |       |       |          |
|  32 |                  TABLE ACCESS BY INDEX ROWID          | DISTANCES   |     70 |      1 |     70 |00:00:00.01 |       3 |       |       |          |
|* 33 |              INDEX UNIQUE SCAN                        | DISTANCE_PK |     25 |      1 |     25 |00:00:00.01 |      27 |       |       |          |
|  34 |             TABLE ACCESS BY INDEX ROWID               | DISTANCES   |     25 |      1 |     25 |00:00:00.01 |      25 |       |       |          |
|  35 |    TABLE ACCESS BY INDEX ROWID                        | DISTANCES   |    150 |      1 |    125 |00:00:00.01 |     251 |       |       |          |
|* 36 |     INDEX UNIQUE SCAN                                 | DISTANCE_PK |    150 |      1 |    125 |00:00:00.01 |     126 |       |       |          |
----------------------------------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   6 - access("TWN"."ID"="TOP"."TOWN_ID")
       filter("TWN"."ID"="TOP"."TOWN_ID")
  16 - filter("CIRCUITS"."PATH_RNK"<=:KEEP_NUM)
  17 - filter(ROW_NUMBER() OVER ( PARTITION BY "R"."ROOT_LEG" ORDER BY :SIGN*("R"."TOT_PRICE"+"D"."DST"))<=:KEEP_NUM)
  20 - filter(("R"."LEV"="R"."N_TOWNS" AND "R"."PATH_RNK"<=:KEEP_NUM))
  22 - filter("D"."RNK_BY_DST"<=:KEEP_NUM_ROOT)
  23 - filter(ROW_NUMBER() OVER ( ORDER BY :SIGN*"DST")<=:KEEP_NUM_ROOT)
  26 - filter("B">"A")
  31 - access("D"."A"="R"."NXT_ID")
       filter("R"."PATH" NOT LIKE '%|'||LPAD(TO_CHAR("D"."B"),3,'0')||'%')
  33 - access("D"."A"="R"."NXT_ID" AND "D"."B"="R"."ROOT")
  36 - access("DST"."A"="TOP"."TOWN_ID_PRIOR" AND "DST"."B"="TOP"."TOWN_ID")


78 rows selected.

Elapsed: 00:00:00.04
SQL> COMMIT
  2  /

Commit complete.

Elapsed: 00:00:00.00
SQL> SELECT 'End: ' || To_Char(SYSDATE,'DD-MON-YYYY HH24:MI:SS') FROM DUAL;

'END:'||TO_CHAR(SYSDATE,'DD-MON-YY
----------------------------------
End: 14-JUL-2013 09:07:44

Elapsed: 00:00:00.00
SQL> SPOOL OFF
